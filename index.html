<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Receipt Builder - 80mm + Bluetooth</title>

  <!-- QR library (preview only) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --bg:#f3f4f6;
      --card:#ffffff;
      --line:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
      --btn:#111827;
      --btn2:#2563eb;
      --danger:#dc2626;
      --ok:#16a34a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Tajawal", sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width:1200px;
      margin:18px auto;
      padding:14px;
      display:grid;
      grid-template-columns: 1fr 420px;
      gap:14px;
    }
    @media (max-width: 980px){
      .wrap{grid-template-columns:1fr; }
    }
    .panel{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
    }
    h2{margin:0 0 10px;font-size:16px}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 600px){
      .grid{grid-template-columns:1fr}
    }
    label{font-size:12px;color:var(--muted);display:block;margin:6px 0}
    input, textarea, select{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    textarea{min-height:74px;resize:vertical}
    input:focus, textarea:focus, select:focus{
      border-color:#c7d2fe;
      box-shadow:0 0 0 4px rgba(37,99,235,.12);
    }
    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
      align-items:center;
    }
    button{
      border:none;
      cursor:pointer;
      padding:10px 14px;
      border-radius:12px;
      font-weight:800;
      font-size:14px;
    }
    .btn-dark{background:var(--btn);color:#fff}
    .btn-blue{background:var(--btn2);color:#fff}
    .btn-ghost{background:#fff;border:1px solid var(--line);color:var(--text);font-weight:700}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-ok{background:var(--ok);color:#fff}

    .status{
      font-size:12px;
      color:var(--muted);
      padding:8px 10px;
      border:1px dashed var(--line);
      border-radius:12px;
      flex:1;
      min-width:220px;
      background:#fff;
    }

    /* Items table (form) */
    .items{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:12px;
      margin-top:10px;
      background:#fff;
    }
    .items th, .items td{
      padding:10px;
      border-bottom:1px solid var(--line);
      font-size:13px;
      text-align:right;
      vertical-align:middle;
    }
    .items th{
      background:#f9fafb;
      color:#374151;
      font-weight:800;
      white-space:nowrap;
    }
    .items tr:last-child td{border-bottom:none}
    .items input{
      padding:8px 10px;
      border-radius:10px;
      font-size:13px;
    }

    /* Receipt preview (80mm) */
    .receipt-shell{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
    }
    .receipt{
      width:320px;
      max-width:100%;
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px 12px;
      box-shadow:0 10px 25px rgba(0,0,0,.06);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
      color:#000;
      direction:ltr;
    }
    .center{text-align:center}
    .sep{border-top:1px solid #000;margin:10px 0}
    .row2{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:13px;
      line-height:1.45;
    }
    .small{font-size:12px;line-height:1.5}
    .bold{font-weight:800}
    .right{text-align:right}
    .left{text-align:left}
    .auto-dir{direction:auto; unicode-bidi: plaintext;}
    .items-r{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .items-r th, .items-r td{
      padding:6px 0;
      border-bottom:1px solid #000;
    }
    .items-r thead th{
      border-bottom:1px solid #000;
      padding-bottom:8px;
    }
    .items-r tbody tr:last-child td{border-bottom:none}
    .qrbox{
      display:flex;
      justify-content:center;
      margin-top:10px;
    }
    #qrPreview{ width:128px;height:128px; }

    /* Print: only receipt, 80mm */
    @media print{
      body{background:#fff}
      .wrap{display:block; padding:0; margin:0}
      .panel{display:none !important}
      .receipt-shell{display:block}
      .receipt{
        width:80mm;
        border:none;
        border-radius:0;
        box-shadow:none;
        padding:6mm 5mm;
      }
      @page{
        size: 80mm auto;
        margin: 0;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- FORM PANEL -->
    <div class="panel">
      <h2>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ÙØ§ØªÙˆØ±Ø© 80mm Ù…Ø«Ù„ Ø§Ù„ØªØ°ÙƒØ±Ø©)</h2>

      <div class="grid">
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„</label>
          <input id="shopName" value="Biryani Box">
        </div>
        <div>
          <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­Ù„ (Ø³Ø·Ø± ØµØºÙŠØ±)</label>
          <input id="shopStreet" value="2 mars">
        </div>

        <div>
          <label>Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø­Ù„</label>
          <input id="shopPhone" value="+212611113425">
        </div>
        <div>
          <label>Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø­Ù„</label>
          <input id="shopEmail" value="biryani@gmail.com">
        </div>

        <div>
          <label>Order ID / Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</label>
          <input id="orderId" value="100243">
        </div>
        <div>
          <label>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</label>
          <input id="orderDateTime" type="datetime-local">
        </div>

        <div>
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</label>
          <select id="orderType">
            <option value="Delivery">Delivery</option>
            <option value="Pickup">Pickup</option>
          </select>
        </div>
        <div>
          <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
          <select id="paymentMethod">
            <option value="Cash On Delivery">Cash On Delivery</option>
            <option value="Card">Card</option>
            <option value="Online">Online</option>
          </select>
        </div>

        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
          <input id="customerName" value="Ivan">
        </div>
        <div>
          <label>Ù‡Ø§ØªÙ Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
          <input id="customerPhone" value="+2120604535185">
        </div>

        <div style="grid-column:1 / -1;">
          <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
          <textarea id="customerAddress">H9GM+8VP, Av. 2 Mars, Casablanca 20250, Morocco</textarea>
        </div>

        <div>
          <label>Ø§Ù„Ø¹Ù…Ù„Ø©</label>
          <input id="currency" value="Ø¯.Ù…">
        </div>
        <div>
          <label>QR (Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚) - Ø§Ø®ØªÙŠØ§Ø±ÙŠ</label>
          <input id="appLink" value="https://example.com/app">
        </div>

        <div>
          <label>Discount</label>
          <input id="discount" type="number" step="0.01" value="0">
        </div>
        <div>
          <label>Coupon Discount</label>
          <input id="couponDiscount" type="number" step="0.01" value="0">
        </div>

        <div>
          <label>VAT/Tax (Tax Included)</label>
          <input id="tax" type="number" step="0.01" value="0">
        </div>
        <div>
          <label>Delivery man tips</label>
          <input id="tips" type="number" step="0.01" value="0">
        </div>

        <div>
          <label>Delivery Fee</label>
          <input id="deliveryFee" type="number" step="0.01" value="0">
        </div>
        <div>
          <label>Ù†Øµ Ø£Ø³ÙÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
          <input id="footerText" value="bladigo. Bladigo 2025">
        </div>
      </div>

      <h2 style="margin-top:14px;">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
      <table class="items" dir="rtl">
        <thead>
          <tr>
            <th style="width:44%">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
            <th style="width:16%">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th style="width:20%">Ø§Ù„Ø«Ù…Ù†</th>
            <th style="width:20%">Ø­Ø°Ù</th>
          </tr>
        </thead>
        <tbody id="itemsBody">
          <tr>
            <td><input class="i-name" value="ÙƒØ¨Ø³Ø© Ø¯Ø¬Ø§Ø¬ ØªÙ‚Ù„ÙŠØ¯ÙŠØ©"></td>
            <td><input class="i-qty" type="number" min="1" value="1"></td>
            <td><input class="i-price" type="number" min="0" step="0.01" value="35"></td>
            <td><button class="btn-danger" type="button" onclick="removeItem(this)">Ø­Ø°Ù</button></td>
          </tr>
        </tbody>
      </table>

      <div class="btns">
        <button class="btn-blue" type="button" onclick="addItem()">+ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
        <button class="btn-ghost" type="button" onclick="renderReceipt()">ØªØ­Ø¯ÙŠØ«</button>

        <!-- Normal print (best for Bluetooth printer via OS) -->
        <button class="btn-dark" type="button" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© (Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©)</button>

        <!-- Bluetooth BLE direct print -->
        <button class="btn-ok" type="button" onclick="bleConnect()">ğŸ”µ Ø±Ø¨Ø· Bluetooth</button>
        <button class="btn-blue" type="button" onclick="blePrint()">ğŸ”µ Print Bluetooth</button>
        <button class="btn-ghost" type="button" onclick="bleDisconnect()">ÙØµÙ„</button>

        <div class="status" id="bleStatus">Bluetooth: ØºÙŠØ± Ù…ØªØµÙ„</div>
      </div>

      <div style="margin-top:10px;color:var(--muted);font-size:12px;line-height:1.6">
        âœ… Ø§Ù„Ø£ÙØ¶Ù„: Ø±Ø¨Ø· Ø§Ù„Ø·Ø§Ø¨Ø¹Ø© Ø¨Ø§Ù„Ø¨Ù„ÙˆØªÙˆØ« Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‡Ø§ØªÙ/PC Ø«Ù… Ø§Ø³ØªØ¹Ù…Ù„ Ø²Ø± â€œØ·Ø¨Ø§Ø¹Ø© (Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©)â€ ÙˆØ§Ø®ØªØ± Ø§Ù„Ø·Ø§Ø¨Ø¹Ø©.<br>
        âš ï¸ Ø²Ø± â€œPrint Bluetoothâ€ ÙƒÙŠØ®Ø¯Ù… ÙÙ‚Ø· Ù…Ø¹ Ø·Ø§Ø¨Ø¹Ø§Øª BLE ESC/POS ÙˆØ¨Ø¹Ø¶ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©/Ø§Ù„Ù…ØªØµÙØ­Ø§Øª (Chrome Android + https).<br>
        âš ï¸ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¹Ø¨Ø± BLE Ù‚Ø¯ Ù„Ø§ ØªØ¸Ù‡Ø± ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ø·Ø§Ø¨Ø¹Ø§Øª (ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø¯Ø¹Ù… Ø§Ù„Ø·Ø§Ø¨Ø¹Ø©).
      </div>
    </div>

    <!-- RECEIPT PREVIEW -->
    <div class="receipt-shell">
      <div class="receipt" id="receipt">
        <div class="center bold" style="font-size:18px" id="rShopName">Biryani Box</div>
        <div class="center small auto-dir" id="rShopStreet">2 mars</div>
        <div class="center small auto-dir" id="rShopPhone">+212611113425</div>
        <div class="center small auto-dir" id="rShopEmail">biryani@gmail.com</div>

        <div class="sep"></div>

        <div class="row2">
          <div class="bold">Order ID:</div>
          <div class="bold auto-dir" id="rOrderId">100243</div>
        </div>
        <div class="small auto-dir" id="rDateTime">31 Jan 2026 17:04</div>

        <div class="sep"></div>

        <div class="row2">
          <div class="bold auto-dir" id="rOrderType">Delivery</div>
          <div class="bold auto-dir" id="rPayment">Cash On Delivery</div>
        </div>

        <div class="sep"></div>

        <div class="bold auto-dir" id="rCustomerName">Ivan</div>
        <div class="small auto-dir" id="rCustomerAddress">H9GM+8VP, Av. 2 Mars, Casablanca 20250, Morocco</div>
        <div class="small auto-dir" id="rCustomerPhone">+2120604535185</div>

        <div class="sep"></div>

        <table class="items-r">
          <thead>
            <tr>
              <th class="left">SL</th>
              <th class="left">Item Info</th>
              <th class="right">Qty</th>
              <th class="right">Price</th>
            </tr>
          </thead>
          <tbody id="rItems"></tbody>
        </table>

        <div class="sep"></div>

        <div class="row2"><div>Item Price</div><div><span id="rItemPrice">0.00</span> <span id="rCur1">Ø¯.Ù…</span></div></div>
        <div class="row2"><div>Subtotal</div><div><span id="rSubtotal">0.00</span> <span id="rCur2">Ø¯.Ù…</span></div></div>
        <div class="row2"><div>Discount</div><div><span id="rDiscount">0.00</span> <span id="rCur3">Ø¯.Ù…</span></div></div>
        <div class="row2"><div>Coupon Discount</div><div><span id="rCoupon">0.00</span> <span id="rCur4">Ø¯.Ù…</span></div></div>
        <div class="row2"><div>Vat/Tax(Tax Included)</div><div><span id="rTax">0.00</span> <span id="rCur5">Ø¯.Ù…</span></div></div>
        <div class="row2"><div>Delivery man tips</div><div><span id="rTips">0.00</span> <span id="rCur6">Ø¯.Ù…</span></div></div>
        <div class="row2"><div>Delivery Fee</div><div><span id="rDeliveryFee">0.00</span> <span id="rCur7">Ø¯.Ù…</span></div></div>

        <div class="sep"></div>

        <div class="row2" style="font-size:16px;">
          <div class="bold">Total Amount</div>
          <div class="bold"><span id="rTotal">0.00</span> <span id="rCur8">Ø¯.Ù…</span></div>
        </div>

        <div class="sep"></div>

        <div class="center bold">Thank You</div>

        <div class="qrbox">
          <div id="qrPreview"></div>
        </div>

        <div class="sep"></div>
        <div class="center small auto-dir" id="rFooter">bladigo. Bladigo 2025</div>
      </div>
    </div>

  </div>

  <script>
    // Helpers
    const $ = (id)=>document.getElementById(id);
    const money = (n)=>Number(n||0).toFixed(2);

    // QR (preview only)
    let qrObj = null;
    function buildQR(text){
      const box = $("qrPreview");
      box.innerHTML = "";
      if(!text) return;
      qrObj = new QRCode(box, {
        text,
        width: 120,
        height: 120,
        correctLevel: QRCode.CorrectLevel.M
      });
    }

    // Items
    function addItem(){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input class="i-name" value="Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯"></td>
        <td><input class="i-qty" type="number" min="1" value="1"></td>
        <td><input class="i-price" type="number" min="0" step="0.01" value="0"></td>
        <td><button class="btn-danger" type="button" onclick="removeItem(this)">Ø­Ø°Ù</button></td>
      `;
      $("itemsBody").appendChild(tr);
      renderReceipt();
    }
    function removeItem(btn){
      const tbody = $("itemsBody");
      const row = btn.closest("tr");
      if(tbody.rows.length === 1){
        row.querySelector(".i-name").value = "Ù…Ù†ØªØ¬ 1";
        row.querySelector(".i-qty").value = 1;
        row.querySelector(".i-price").value = 0;
      }else{
        row.remove();
      }
      renderReceipt();
    }

    function getItems(){
      const rows = [...document.querySelectorAll("#itemsBody tr")];
      return rows.map(r=>({
        name: r.querySelector(".i-name").value.trim(),
        qty: Number(r.querySelector(".i-qty").value || 0),
        price: Number(r.querySelector(".i-price").value || 0),
      })).filter(x=>x.name && x.qty>0);
    }

    function formatDateTime(dtLocal){
      if(!dtLocal) return "";
      const d = new Date(dtLocal);
      if(isNaN(d.getTime())) return dtLocal;
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const dd = String(d.getDate()).padStart(2,"0");
      const mon = months[d.getMonth()];
      const yyyy = d.getFullYear();
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `${dd} ${mon} ${yyyy} ${hh}:${mm}`;
    }

    function renderReceipt(){
      $("rShopName").textContent = $("shopName").value || "";
      $("rShopStreet").textContent = $("shopStreet").value || "";
      $("rShopPhone").textContent = $("shopPhone").value || "";
      $("rShopEmail").textContent = $("shopEmail").value || "";

      $("rOrderId").textContent = $("orderId").value || "";
      $("rDateTime").textContent = formatDateTime($("orderDateTime").value) || "";
      $("rOrderType").textContent = $("orderType").value || "";
      $("rPayment").textContent = $("paymentMethod").value || "";

      $("rCustomerName").textContent = $("customerName").value || "";
      $("rCustomerAddress").textContent = $("customerAddress").value || "";
      $("rCustomerPhone").textContent = $("customerPhone").value || "";

      const cur = $("currency").value || "";
      ["rCur1","rCur2","rCur3","rCur4","rCur5","rCur6","rCur7","rCur8"].forEach(id=>{
        $(id).textContent = cur;
      });

      const items = getItems();
      const tbody = $("rItems");
      tbody.innerHTML = "";
      let itemPriceSum = 0;

      items.forEach((it, idx)=>{
        const line = it.qty * it.price;
        itemPriceSum += line;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="left">${idx+1}</td>
          <td class="left auto-dir">${escapeHtml(it.name)}</td>
          <td class="right">${it.qty}</td>
          <td class="right">${money(line)}</td>
        `;
        tbody.appendChild(tr);
      });

      const discount = Number($("discount").value || 0);
      const coupon = Number($("couponDiscount").value || 0);
      const tax = Number($("tax").value || 0);
      const tips = Number($("tips").value || 0);
      const deliveryFee = Number($("deliveryFee").value || 0);

      const subtotal = itemPriceSum;
      const total = Math.max(subtotal - discount - coupon, 0) + tax + tips + deliveryFee;

      $("rItemPrice").textContent = money(itemPriceSum);
      $("rSubtotal").textContent = money(subtotal);
      $("rDiscount").textContent = money(discount);
      $("rCoupon").textContent = money(coupon);
      $("rTax").textContent = money(tax);
      $("rTips").textContent = money(tips);
      $("rDeliveryFee").textContent = money(deliveryFee);
      $("rTotal").textContent = money(total);

      $("rFooter").textContent = $("footerText").value || "";
      buildQR(($("appLink").value || "").trim());

      saveToLocal();
    }

    function escapeHtml(str){
      return String(str||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // LocalStorage
    function saveToLocal(){
      localStorage.setItem("receipt_builder_v2", JSON.stringify(collectData()));
    }
    function loadFromLocal(){
      const raw = localStorage.getItem("receipt_builder_v2");
      if(!raw) return false;
      try{
        const d = JSON.parse(raw);
        if(!d) return false;
        const set = (id,val)=>{ if($(id)) $(id).value = val ?? ""; };

        set("shopName", d.shopName);
        set("shopStreet", d.shopStreet);
        set("shopPhone", d.shopPhone);
        set("shopEmail", d.shopEmail);
        set("orderId", d.orderId);
        set("orderDateTime", d.orderDateTime);
        set("orderType", d.orderType);
        set("paymentMethod", d.paymentMethod);
        set("customerName", d.customerName);
        set("customerPhone", d.customerPhone);
        set("customerAddress", d.customerAddress);
        set("currency", d.currency);
        set("appLink", d.appLink);
        set("discount", d.discount);
        set("couponDiscount", d.couponDiscount);
        set("tax", d.tax);
        set("tips", d.tips);
        set("deliveryFee", d.deliveryFee);
        set("footerText", d.footerText);

        const tbody = $("itemsBody");
        tbody.innerHTML = "";
        (d.items || []).forEach(it=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><input class="i-name" value="${escapeHtml(it.name)}"></td>
            <td><input class="i-qty" type="number" min="1" value="${it.qty || 1}"></td>
            <td><input class="i-price" type="number" min="0" step="0.01" value="${it.price || 0}"></td>
            <td><button class="btn-danger" type="button" onclick="removeItem(this)">Ø­Ø°Ù</button></td>
          `;
          tbody.appendChild(tr);
        });
        if(!tbody.rows.length){
          addItem();
        }
        return true;
      }catch(e){
        return false;
      }
    }
    function collectData(){
      return {
        shopName: $("shopName").value,
        shopStreet: $("shopStreet").value,
        shopPhone: $("shopPhone").value,
        shopEmail: $("shopEmail").value,
        orderId: $("orderId").value,
        orderDateTime: $("orderDateTime").value,
        orderType: $("orderType").value,
        paymentMethod: $("paymentMethod").value,
        customerName: $("customerName").value,
        customerPhone: $("customerPhone").value,
        customerAddress: $("customerAddress").value,
        currency: $("currency").value,
        appLink: $("appLink").value,
        discount: $("discount").value,
        couponDiscount: $("couponDiscount").value,
        tax: $("tax").value,
        tips: $("tips").value,
        deliveryFee: $("deliveryFee").value,
        footerText: $("footerText").value,
        items: getItems()
      };
    }

    // Auto render
    function wireAutoRender(){
      document.querySelectorAll("input, textarea, select").forEach(el=>{
        el.addEventListener("input", renderReceipt);
        el.addEventListener("change", renderReceipt);
      });
      $("itemsBody").addEventListener("input", (e)=>{
        if(e.target.classList.contains("i-name") ||
           e.target.classList.contains("i-qty") ||
           e.target.classList.contains("i-price")){
          renderReceipt();
        }
      });
    }

    /* ===========================
       BLUETOOTH (Web Bluetooth BLE)
       ===========================
       Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ø·Ø§Ø¨Ø¹Ø©. ÙƒØ«ÙŠØ± Ù…Ù† Ø·Ø§Ø¨Ø¹Ø§Øª ESC/POS BLE ØªØ³ØªØ¹Ù…Ù„:
       - Service UUID: 0xFFE0
       - Characteristic UUID: 0xFFE1
       Ù„ÙƒÙ† Ù„ÙŠØ³ Ø¯Ø§Ø¦Ù…Ø§Ù‹.
    */
    let bleDevice = null;
    let bleChar = null;

    function setBleStatus(msg){
      $("bleStatus").textContent = "Bluetooth: " + msg;
    }

    async function bleConnect(){
      try{
        if(!navigator.bluetooth){
          setBleStatus("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Web Bluetooth. Ø§Ø³ØªØ¹Ù…Ù„ Chrome Android + https.");
          return;
        }

        setBleStatus("Ø§Ø®ØªÙØ± Ø§Ù„Ø·Ø§Ø¨Ø¹Ø© Ù…Ù† Ø§Ù„Ù„Ø§Ø¦Ø­Ø©...");

        // Ù†Ø­Ø§ÙˆÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø¬Ù‡Ø§Ø² Ù…Ø¹ Ø®Ø¯Ù…Ø§Øª Ø´Ø§Ø¦Ø¹Ø© Ù„Ù„Ø·Ø§Ø¨Ø¹Ø§Øª
        bleDevice = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: [
            "0000ffe0-0000-1000-8000-00805f9b34fb", // common
            "0000ffe1-0000-1000-8000-00805f9b34fb", // sometimes as service
            "000018f0-0000-1000-8000-00805f9b34fb", // some printers
          ]
        });

        bleDevice.addEventListener("gattserverdisconnected", ()=>{
          bleChar = null;
          setBleStatus("Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„");
        });

        const server = await bleDevice.gatt.connect();

        // Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ characteristic ÙÙŠÙ‡ write
        const services = await server.getPrimaryServices();
        for(const s of services){
          const chars = await s.getCharacteristics();
          for(const c of chars){
            const p = c.properties;
            if(p.write || p.writeWithoutResponse){
              bleChar = c;
              setBleStatus("Ù…ØªØµÙ„ âœ… (" + (bleDevice.name || "Printer") + ")");
              return;
            }
          }
        }

        setBleStatus("ØªØµÙ„Ù†Ø§ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆÙ„ÙƒÙ† Ù…Ø§ Ù„Ù‚ÙŠÙ†Ø§Ø´ write characteristic (ÙŠÙ…ÙƒÙ† Ø§Ù„Ø·Ø§Ø¨Ø¹Ø© Ù…Ø§ ÙƒØªØ¯Ø¹Ù…Ø´ BLE ESC/POS).");
      }catch(err){
        setBleStatus("ÙØ´Ù„: " + (err?.message || err));
      }
    }

    async function bleDisconnect(){
      try{
        if(bleDevice?.gatt?.connected) bleDevice.gatt.disconnect();
      }catch(e){}
      bleChar = null;
      setBleStatus("ØºÙŠØ± Ù…ØªØµÙ„");
    }

    // Build ESC/POS text (80mm ~ 48 chars / line)
    function buildReceiptText48(){
      const W = 48;
      const line = (ch="-") => (ch.repeat(W) + "\n");
      const center = (txt) => {
        txt = String(txt || "");
        if(txt.length >= W) return txt.slice(0,W) + "\n";
        const pad = Math.floor((W - txt.length)/2);
        return (" ".repeat(pad) + txt + "\n");
      };
      const lr = (l,r) => {
        l = String(l||"");
        r = String(r||"");
        const space = W - l.length - r.length;
        if(space <= 1) return (l + " " + r).slice(0,W) + "\n";
        return l + " ".repeat(space) + r + "\n";
      };

      const shopName = $("shopName").value;
      const shopStreet = $("shopStreet").value;
      const shopPhone = $("shopPhone").value;
      const shopEmail = $("shopEmail").value;

      const orderId = $("orderId").value;
      const dt = formatDateTime($("orderDateTime").value);
      const orderType = $("orderType").value;
      const pay = $("paymentMethod").value;

      const custName = $("customerName").value;
      const custAddr = $("customerAddress").value;
      const custPhone = $("customerPhone").value;

      const cur = $("currency").value || "";

      const items = getItems();
      let sum = 0;

      const discount = Number($("discount").value||0);
      const coupon = Number($("couponDiscount").value||0);
      const tax = Number($("tax").value||0);
      const tips = Number($("tips").value||0);
      const deliveryFee = Number($("deliveryFee").value||0);

      let out = "";
      out += center(shopName);
      out += center(shopStreet);
      out += center(shopPhone);
      out += center(shopEmail);
      out += line();

      out += lr("Order ID:", orderId);
      out += (dt ? (dt + "\n") : "");
      out += line();

      out += lr(orderType, pay);
      out += line();

      out += (custName ? (custName + "\n") : "");
      if(custAddr){
        // split address into lines roughly
        const parts = custAddr.split(/\n|, /).filter(Boolean);
        for(const p of parts){
          out += (p.length > W ? p.slice(0,W) : p) + "\n";
        }
      }
      out += (custPhone ? (custPhone + "\n") : "");
      out += line();

      // Items header
      out += lr("SL  ITEM", "QTY   PRICE");
      out += line();

      items.forEach((it, i)=>{
        const total = it.qty * it.price;
        sum += total;
        const left = `${i+1}  ${it.name}`.slice(0, 32);
        const right = `${it.qty}   ${money(total)}`.slice(0, 14);
        out += lr(left, right);
      });

      out += line();

      const subtotal = sum;
      const totalAll = Math.max(subtotal - discount - coupon, 0) + tax + tips + deliveryFee;

      out += lr("Item Price", `${money(sum)} ${cur}`);
      out += lr("Subtotal", `${money(subtotal)} ${cur}`);
      out += lr("Discount", `${money(discount)} ${cur}`);
      out += lr("Coupon Discount", `${money(coupon)} ${cur}`);
      out += lr("Vat/Tax(Included)", `${money(tax)} ${cur}`);
      out += lr("Delivery tips", `${money(tips)} ${cur}`);
      out += lr("Delivery Fee", `${money(deliveryFee)} ${cur}`);

      out += line();

      out += lr("TOTAL AMOUNT", `${money(totalAll)} ${cur}`);
      out += line();
      out += center("Thank You");
      out += line();
      out += center($("footerText").value);

      // Feed lines
      out += "\n\n\n";
      return out;
    }

    function escposBytesForText(text){
      const enc = new TextEncoder(); // UTF-8 (some printers may not support Arabic)
      const init = new Uint8Array([0x1B,0x40]);        // ESC @
      const alignCenter = new Uint8Array([0x1B,0x61,0x01]); // ESC a 1
      const alignLeft = new Uint8Array([0x1B,0x61,0x00]);   // ESC a 0
      const boldOn = new Uint8Array([0x1B,0x45,0x01]);
      const boldOff = new Uint8Array([0x1B,0x45,0x00]);
      const cut = new Uint8Array([0x1D,0x56,0x01]);    // GS V 1 (partial cut, some ignore)

      const body = enc.encode(text);

      // We keep it simple: init + text + cut
      // (alignment/bold is handled by spaces in text; you can expand if needed)
      const all = new Uint8Array(init.length + body.length + cut.length);
      all.set(init, 0);
      all.set(body, init.length);
      all.set(cut, init.length + body.length);
      return all;
    }

    async function bleWriteAll(u8){
      if(!bleChar) throw new Error("ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø·Ø§Ø¨Ø¹Ø©. Ø§Ø¶ØºØ· 'Ø±Ø¨Ø· Bluetooth' Ø£ÙˆÙ„Ø§Ù‹.");
      const chunkSize = 20; // safest for BLE
      for(let i=0; i<u8.length; i+=chunkSize){
        const chunk = u8.slice(i, i+chunkSize);
        if(bleChar.properties.writeWithoutResponse){
          await bleChar.writeValueWithoutResponse(chunk);
        }else{
          await bleChar.writeValue(chunk);
        }
        // tiny delay helps some printers
        await new Promise(r=>setTimeout(r, 10));
      }
    }

    async function blePrint(){
      try{
        if(!bleChar){
          setBleStatus("Ø®Ø§ØµÙƒ ØªØ±Ø¨Ø· Ø§Ù„Ø·Ø§Ø¨Ø¹Ø© Ø£ÙˆÙ„Ø§Ù‹");
          return;
        }
        renderReceipt(); // ensure up-to-date
        setBleStatus("ÙƒÙŠØ·Ø¨Ø¹...");

        const txt = buildReceiptText48();
        const bytes = escposBytesForText(txt);

        await bleWriteAll(bytes);
        setBleStatus("ØªÙ…Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© âœ…");
      }catch(err){
        setBleStatus("ÙØ´Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: " + (err?.message || err));
      }
    }

    // Init
    (function init(){
      const now = new Date();
      const pad = n => String(n).padStart(2,"0");
      const local = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
      if(!$("orderDateTime").value) $("orderDateTime").value = local;

      loadFromLocal();
      wireAutoRender();
      renderReceipt();
    })();
  </script>
</body>
</html>
