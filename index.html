<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ÙØ§ØªÙˆØ±Ø© 80mm + ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© + Ø£Ø±Ø´ÙŠÙ + Ø±Ù‚Ù… Ø·Ù„Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ</title>

  <!-- QR (preview) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <!-- Download as image -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#f3f4f6;
      --card:#ffffff;
      --line:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
      --btn:#111827;
      --btn2:#2563eb;
      --danger:#dc2626;
      --ok:#16a34a;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Tajawal", sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width:1280px;
      margin:18px auto;
      padding:14px;
      display:grid;
      grid-template-columns: 1fr 420px;
      gap:14px;
    }
    @media (max-width: 980px){
      .wrap{grid-template-columns:1fr;}
    }
    .panel{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
    }
    h2{margin:0 0 10px;font-size:16px}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 600px){
      .grid{grid-template-columns:1fr}
    }
    label{font-size:12px;color:var(--muted);display:block;margin:6px 0}
    input, textarea, select{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    textarea{min-height:74px;resize:vertical}
    input:focus, textarea:focus, select:focus{
      border-color:#c7d2fe;
      box-shadow:0 0 0 4px rgba(37,99,235,.12);
    }
    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
      align-items:center;
    }
    button{
      border:none;
      cursor:pointer;
      padding:10px 14px;
      border-radius:12px;
      font-weight:800;
      font-size:14px;
      white-space:nowrap;
    }
    .btn-dark{background:var(--btn);color:#fff}
    .btn-blue{background:var(--btn2);color:#fff}
    .btn-ghost{background:#fff;border:1px solid var(--line);color:var(--text);font-weight:700}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-ok{background:var(--ok);color:#fff}
    .btn-warn{background:var(--warn);color:#111}
    .status{
      font-size:12px;
      color:var(--muted);
      padding:8px 10px;
      border:1px dashed var(--line);
      border-radius:12px;
      flex:1;
      min-width:220px;
      background:#fff;
    }

    /* Items table (form) */
    .items{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:12px;
      margin-top:10px;
      background:#fff;
    }
    .items th, .items td{
      padding:10px;
      border-bottom:1px solid var(--line);
      font-size:13px;
      text-align:right;
      vertical-align:middle;
    }
    .items th{
      background:#f9fafb;
      color:#374151;
      font-weight:800;
      white-space:nowrap;
    }
    .items tr:last-child td{border-bottom:none}
    .items input{
      padding:8px 10px;
      border-radius:10px;
      font-size:13px;
    }

    /* Receipt preview */
    .receipt-shell{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
    }
    .receipt{
      width:320px;
      max-width:100%;
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px 12px;
      box-shadow:0 10px 25px rgba(0,0,0,.06);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
      color:#000;
      direction:ltr;
    }
    .center{text-align:center}
    .sep{border-top:1px solid #000;margin:10px 0}
    .row2{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:13px;
      line-height:1.45;
    }
    .small{font-size:12px;line-height:1.5}
    .bold{font-weight:800}
    .right{text-align:right}
    .left{text-align:left}
    .auto-dir{direction:auto; unicode-bidi: plaintext;}
    .items-r{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .items-r th, .items-r td{
      padding:6px 0;
      border-bottom:1px solid #000;
    }
    .items-r thead th{
      border-bottom:1px solid #000;
      padding-bottom:8px;
    }
    .items-r tbody tr:last-child td{border-bottom:none}
    .qrbox{
      display:flex;
      justify-content:center;
      margin-top:10px;
    }
    #qrPreview{ width:128px;height:128px; }

    /* Archive UI */
    .section{
      margin-top:14px;
      padding-top:12px;
      border-top:1px solid var(--line);
    }
    .mini{
      font-size:12px;
      color:var(--muted);
      line-height:1.6;
    }
    .arch-head{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .arch-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:12px;
      margin-top:10px;
      background:#fff;
    }
    .table th,.table td{
      padding:10px;
      border-bottom:1px solid var(--line);
      font-size:12px;
      text-align:right;
      vertical-align:middle;
    }
    .table th{
      background:#f9fafb;
      color:#374151;
      font-weight:800;
      white-space:nowrap;
    }
    .table tr:last-child td{border-bottom:none}
    .pill{
      display:inline-flex;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:700;
      font-size:12px;
      color:#111;
    }
    .rowbtns{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-start;
    }
    .btn-xs{
      padding:7px 10px;
      border-radius:10px;
      font-size:12px;
      font-weight:800;
    }

    /* Print: only receipt, 80mm */
    @media print{
      body{background:#fff}
      .wrap{display:block; padding:0; margin:0}
      .panel{display:none !important}
      .receipt-shell{display:block}
      .receipt{
        width:80mm;
        border:none;
        border-radius:0;
        box-shadow:none;
        padding:6mm 5mm;
      }
      @page{
        size: 80mm auto;
        margin: 0;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- FORM PANEL -->
    <div class="panel">
      <h2>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (80mm + ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© + Ø£Ø±Ø´ÙŠÙ + Ø±Ù‚Ù… Ø·Ù„Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ)</h2>

      <!-- Auto Order ID Tools -->
      <div class="grid" style="margin-bottom:10px;">
        <div>
          <label>Prefix Ù„Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="orderPrefix" value="ORD-">
        </div>
        <div>
          <label>Ø·ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù… (padding)</label>
          <input id="orderPad" type="number" min="1" value="6">
        </div>
        <div style="grid-column:1 / -1;">
          <div class="btns" style="margin-top:6px;">
            <button class="btn-blue" type="button" onclick="newOrderId()">â• Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</button>
            <button class="btn-ghost" type="button" onclick="resetOrderCounter()">ğŸ” Reset Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯</button>
            <span class="status" id="statusBox">Ø§Ù„Ø­Ø§Ù„Ø©: Ø¬Ø§Ù‡Ø²</span>
          </div>
          <div class="mini">âœ… ÙƒÙ„ Ù…Ø±Ø© ØªØ¶ØºØ· â€œØ±Ù‚Ù… Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯â€ ÙƒÙŠØ²ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (Ù…Ø­ÙÙˆØ¸ Ø­ØªÙ‰ Ù„Ùˆ Ø®Ø±Ø¬Øª Ù…Ù† Ø§Ù„ØµÙØ­Ø©).</div>
        </div>
      </div>

      <div class="grid">
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„</label>
          <input id="shopName" value="Biryani Box">
        </div>
        <div>
          <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­Ù„ (Ø³Ø·Ø± ØµØºÙŠØ±)</label>
          <input id="shopStreet" value="2 mars">
        </div>

        <div>
          <label>Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø­Ù„</label>
          <input id="shopPhone" value="+212611113425">
        </div>
        <div>
          <label>Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø­Ù„</label>
          <input id="shopEmail" value="biryani@gmail.com">
        </div>

        <div>
          <label>Order ID / Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</label>
          <input id="orderId" value="">
        </div>
        <div>
          <label>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</label>
          <input id="orderDateTime" type="datetime-local">
        </div>

        <div>
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</label>
          <select id="orderType">
            <option value="Delivery">Delivery</option>
            <option value="Pickup">Pickup</option>
          </select>
        </div>
        <div>
          <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
          <select id="paymentMethod">
            <option value="Cash On Delivery">Cash On Delivery</option>
            <option value="Card">Card</option>
            <option value="Online">Online</option>
          </select>
        </div>

        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
          <input id="customerName" value="">
        </div>
        <div>
          <label>Ù‡Ø§ØªÙ Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
          <input id="customerPhone" value="">
        </div>

        <div style="grid-column:1 / -1;">
          <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
          <textarea id="customerAddress"></textarea>
        </div>

        <div>
          <label>Ø§Ù„Ø¹Ù…Ù„Ø©</label>
          <input id="currency" value="Ø¯.Ù…">
        </div>
        <div>
          <label>QR (Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚) - Ø§Ø®ØªÙŠØ§Ø±ÙŠ</label>
          <input id="appLink" value="">
        </div>

        <div>
          <label>Discount</label>
          <input id="discount" type="number" step="0.01" value="0">
        </div>
        <div>
          <label>Coupon Discount</label>
          <input id="couponDiscount" type="number" step="0.01" value="0">
        </div>

        <div>
          <label>VAT/Tax (Tax Included)</label>
          <input id="tax" type="number" step="0.01" value="0">
        </div>
        <div>
          <label>Delivery man tips</label>
          <input id="tips" type="number" step="0.01" value="0">
        </div>

        <div>
          <label>Delivery Fee</label>
          <input id="deliveryFee" type="number" step="0.01" value="0">
        </div>
        <div>
          <label>Ù†Øµ Ø£Ø³ÙÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
          <input id="footerText" value="Thank you">
        </div>
      </div>

      <h2 style="margin-top:14px;">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
      <table class="items" dir="rtl">
        <thead>
          <tr>
            <th style="width:44%">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
            <th style="width:16%">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th style="width:20%">Ø§Ù„Ø«Ù…Ù†</th>
            <th style="width:20%">Ø­Ø°Ù</th>
          </tr>
        </thead>
        <tbody id="itemsBody">
          <tr>
            <td><input class="i-name" value="Ù…Ù†ØªØ¬ 1"></td>
            <td><input class="i-qty" type="number" min="1" value="1"></td>
            <td><input class="i-price" type="number" min="0" step="0.01" value="0"></td>
            <td><button class="btn-danger" type="button" onclick="removeItem(this)">Ø­Ø°Ù</button></td>
          </tr>
        </tbody>
      </table>

      <div class="btns">
        <button class="btn-blue" type="button" onclick="addItem()">+ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
        <button class="btn-ghost" type="button" onclick="renderReceipt()">ØªØ­Ø¯ÙŠØ«</button>

        <button class="btn-dark" type="button" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>

        <!-- Download receipt as image + Auto archive -->
        <button class="btn-ghost" type="button" onclick="downloadReceiptImage(true)">ğŸ–¼ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØµÙˆØ±Ø©</button>

        <!-- Manual archive -->
        <button class="btn-ok" type="button" onclick="archiveCurrentInvoice()">âœ… Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
      </div>

      <div class="mini">
        âœ… â€œØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø©â€ ÙƒÙŠØ¯Ø®Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ù„Ø£Ø±Ø´ÙŠÙ + ÙƒÙŠØ³Ø¬Ù„ Ø±Ù‚Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†.
      </div>

      <!-- ARCHIVE -->
      <div class="section">
        <div class="arch-head">
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
            <h2 style="margin:0;">ğŸ“ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</h2>
            <span class="pill" id="archiveCount">0 ÙØ§ØªÙˆØ±Ø©</span>
            <span class="pill" id="customersCount">0 Ø±Ù‚Ù… Ø²Ø¨ÙˆÙ†</span>
          </div>

          <div class="arch-actions">
            <input id="archiveSearch" placeholder="Ø¨Ø­Ø«: Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ / Ø§Ù„Ù‡Ø§ØªÙ / Ø§Ù„Ø§Ø³Ù…..." style="width:280px;max-width:100%;">
            <button class="btn-ghost btn-xs" type="button" onclick="exportArchiveJSON()">â¬‡ï¸ ØªØµØ¯ÙŠØ± JSON</button>
            <button class="btn-danger btn-xs" type="button" onclick="clearArchive()">ğŸ—‘ï¸ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
          </div>
        </div>

        <table class="table" id="archiveTable">
          <thead>
            <tr>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Order</th>
              <th>Ø§Ù„Ø²Ø¨ÙˆÙ†</th>
              <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
              <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="archiveBody"></tbody>
        </table>

        <div class="section" style="margin-top:12px;">
          <div class="arch-head">
            <h2 style="margin:0;">ğŸ“ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</h2>
            <button class="btn-ghost btn-xs" type="button" onclick="clearCustomers()">ğŸ—‘ï¸ Ø­Ø°Ù Ù„Ø§Ø¦Ø­Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù…</button>
          </div>
          <table class="table">
            <thead>
              <tr>
                <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª</th>
                <th>Ø¢Ø®Ø± ØªØ§Ø±ÙŠØ®</th>
              </tr>
            </thead>
            <tbody id="customersBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- RECEIPT PREVIEW -->
    <div class="receipt-shell">
      <div class="receipt" id="receipt">
        <div class="center bold" style="font-size:18px" id="rShopName">Biryani Box</div>
        <div class="center small auto-dir" id="rShopStreet">2 mars</div>
        <div class="center small auto-dir" id="rShopPhone">+212611113425</div>
        <div class="center small auto-dir" id="rShopEmail">biryani@gmail.com</div>

        <div class="sep"></div>

        <div class="row2">
          <div class="bold">Order ID:</div>
          <div class="bold auto-dir" id="rOrderId">ORD-000001</div>
        </div>
        <div class="small auto-dir" id="rDateTime">31 Jan 2026 17:04</div>

        <div class="sep"></div>

        <div class="row2">
          <div class="bold auto-dir" id="rOrderType">Delivery</div>
          <div class="bold auto-dir" id="rPayment">Cash On Delivery</div>
        </div>

        <div class="sep"></div>

        <div class="bold auto-dir" id="rCustomerName">Customer</div>
        <div class="small auto-dir" id="rCustomerAddress">Address</div>
        <div class="small auto-dir" id="rCustomerPhone">Phone</div>

        <div class="sep"></div>

        <table class="items-r">
          <thead>
            <tr>
              <th class="left">SL</th>
              <th class="left">Item Info</th>
              <th class="right">Qty</th>
              <th class="right">Price</th>
            </tr>
          </thead>
          <tbody id="rItems"></tbody>
        </table>

        <div class="sep"></div>

        <div class="row2"><div>Item Price</div><div><span id="rItemPrice">0.00</span> <span id="rCur1">Ø¯.Ù…</span></div></div>
        <div class="row2"><div>Subtotal</div><div><span id="rSubtotal">0.00</span> <span id="rCur2">Ø¯.Ù…</span></div></div>
        <div class="row2"><div>Discount</div><div><span id="rDiscount">0.00</span> <span id="rCur3">Ø¯.Ù…</span></div></div>
        <div class="row2"><div>Coupon Discount</div><div><span id="rCoupon">0.00</span> <span id="rCur4">Ø¯.Ù…</span></div></div>
        <div class="row2"><div>Vat/Tax(Tax Included)</div><div><span id="rTax">0.00</span> <span id="rCur5">Ø¯.Ù…</span></div></div>
        <div class="row2"><div>Delivery man tips</div><div><span id="rTips">0.00</span> <span id="rCur6">Ø¯.Ù…</span></div></div>
        <div class="row2"><div>Delivery Fee</div><div><span id="rDeliveryFee">0.00</span> <span id="rCur7">Ø¯.Ù…</span></div></div>

        <div class="sep"></div>

        <div class="row2" style="font-size:16px;">
          <div class="bold">Total Amount</div>
          <div class="bold"><span id="rTotal">0.00</span> <span id="rCur8">Ø¯.Ù…</span></div>
        </div>

        <div class="sep"></div>

        <div class="center bold">Thank You</div>

        <div class="qrbox">
          <div id="qrPreview"></div>
        </div>

        <div class="sep"></div>
        <div class="center small auto-dir" id="rFooter">Thank you</div>
      </div>
    </div>

  </div>

  <script>
    /* =========================
       Helpers + Status
    ========================= */
    const $ = (id)=>document.getElementById(id);
    const money = (n)=>Number(n||0).toFixed(2);

    function setStatus(msg){
      $("statusBox").textContent = "Ø§Ù„Ø­Ø§Ù„Ø©: " + msg;
    }

    function escapeHtml(str){
      return String(str||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function formatDateTime(dtLocal){
      if(!dtLocal) return "";
      const d = new Date(dtLocal);
      if(isNaN(d.getTime())) return dtLocal;
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const dd = String(d.getDate()).padStart(2,"0");
      const mon = months[d.getMonth()];
      const yyyy = d.getFullYear();
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `${dd} ${mon} ${yyyy} ${hh}:${mm}`;
    }

    function isoNow(){
      return new Date().toISOString();
    }

    /* =========================
       AUTO ORDER ID (Counter)
    ========================= */
    const ORDER_COUNTER_KEY = "order_counter_v1";

    function getCounter(){
      const raw = localStorage.getItem(ORDER_COUNTER_KEY);
      const n = Number(raw || 0);
      return Number.isFinite(n) ? n : 0;
    }

    function setCounter(n){
      localStorage.setItem(ORDER_COUNTER_KEY, String(Number(n || 0)));
    }

    function padNumber(n, width){
      const s = String(Math.max(0, Number(n || 0)));
      const w = Math.max(1, Number(width || 1));
      if(s.length >= w) return s;
      return "0".repeat(w - s.length) + s;
    }

    function makeOrderId(nextNumber){
      const prefix = ($("orderPrefix").value || "").trim();
      const padW = Number($("orderPad").value || 6);
      return `${prefix}${padNumber(nextNumber, padW)}`;
    }

    function newOrderId(){
      let c = getCounter();
      c = c + 1;
      setCounter(c);
      $("orderId").value = makeOrderId(c);
      setStatus("ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ âœ…");
      renderReceipt();
    }

    function resetOrderCounter(){
      const ok = confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Reset Ù„Ù„Ø¹Ø¯Ù‘Ø§Ø¯ØŸ Ø³ÙŠØ¹ÙˆØ¯ Ø¥Ù„Ù‰ 0.");
      if(!ok) return;
      setCounter(0);
      setStatus("ØªÙ… Reset âœ…");
    }

    /* =========================
       QR (preview)
    ========================= */
    function buildQR(text){
      const box = $("qrPreview");
      box.innerHTML = "";
      if(!text) return;
      new QRCode(box, {
        text,
        width: 120,
        height: 120,
        correctLevel: QRCode.CorrectLevel.M
      });
    }

    /* =========================
       Items CRUD
    ========================= */
    function addItem(){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input class="i-name" value="Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯"></td>
        <td><input class="i-qty" type="number" min="1" value="1"></td>
        <td><input class="i-price" type="number" min="0" step="0.01" value="0"></td>
        <td><button class="btn-danger" type="button" onclick="removeItem(this)">Ø­Ø°Ù</button></td>
      `;
      $("itemsBody").appendChild(tr);
      renderReceipt();
    }

    function removeItem(btn){
      const tbody = $("itemsBody");
      const row = btn.closest("tr");
      if(tbody.rows.length === 1){
        row.querySelector(".i-name").value = "Ù…Ù†ØªØ¬ 1";
        row.querySelector(".i-qty").value = 1;
        row.querySelector(".i-price").value = 0;
      }else{
        row.remove();
      }
      renderReceipt();
    }

    function getItems(){
      const rows = [...document.querySelectorAll("#itemsBody tr")];
      return rows.map(r=>({
        name: r.querySelector(".i-name").value.trim(),
        qty: Number(r.querySelector(".i-qty").value || 0),
        price: Number(r.querySelector(".i-price").value || 0),
      })).filter(x=>x.name && x.qty>0);
    }

    /* =========================
       Totals + Receipt render
    ========================= */
    function calcTotals(){
      const items = getItems();
      let itemSum = 0;
      items.forEach(it => itemSum += (it.qty * it.price));

      const discount = Number($("discount").value || 0);
      const coupon = Number($("couponDiscount").value || 0);
      const tax = Number($("tax").value || 0);
      const tips = Number($("tips").value || 0);
      const deliveryFee = Number($("deliveryFee").value || 0);

      const subtotal = itemSum;
      const total = Math.max(subtotal - discount - coupon, 0) + tax + tips + deliveryFee;

      return { itemSum, subtotal, discount, coupon, tax, tips, deliveryFee, total };
    }

    function renderReceipt(){
      $("rShopName").textContent = $("shopName").value || "";
      $("rShopStreet").textContent = $("shopStreet").value || "";
      $("rShopPhone").textContent = $("shopPhone").value || "";
      $("rShopEmail").textContent = $("shopEmail").value || "";

      $("rOrderId").textContent = $("orderId").value || "";
      $("rDateTime").textContent = formatDateTime($("orderDateTime").value) || "";
      $("rOrderType").textContent = $("orderType").value || "";
      $("rPayment").textContent = $("paymentMethod").value || "";

      $("rCustomerName").textContent = $("customerName").value || "";
      $("rCustomerAddress").textContent = $("customerAddress").value || "";
      $("rCustomerPhone").textContent = $("customerPhone").value || "";

      const cur = $("currency").value || "";
      ["rCur1","rCur2","rCur3","rCur4","rCur5","rCur6","rCur7","rCur8"].forEach(id=>{
        $(id).textContent = cur;
      });

      const items = getItems();
      const tbody = $("rItems");
      tbody.innerHTML = "";
      items.forEach((it, idx)=>{
        const line = it.qty * it.price;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="left">${idx+1}</td>
          <td class="left auto-dir">${escapeHtml(it.name)}</td>
          <td class="right">${it.qty}</td>
          <td class="right">${money(line)}</td>
        `;
        tbody.appendChild(tr);
      });

      const t = calcTotals();
      $("rItemPrice").textContent = money(t.itemSum);
      $("rSubtotal").textContent = money(t.subtotal);
      $("rDiscount").textContent = money(t.discount);
      $("rCoupon").textContent = money(t.coupon);
      $("rTax").textContent = money(t.tax);
      $("rTips").textContent = money(t.tips);
      $("rDeliveryFee").textContent = money(t.deliveryFee);
      $("rTotal").textContent = money(t.total);

      $("rFooter").textContent = $("footerText").value || "";
      buildQR(($("appLink").value || "").trim());

      saveDraftToLocal();
    }

    /* =========================
       Download PNG (and archive)
    ========================= */
    async function downloadReceiptImage(addToArchiveAfter){
      try{
        renderReceipt();

        // If orderId empty, generate one automatically
        if(!($("orderId").value || "").trim()){
          newOrderId();
        }

        setStatus("ØªØ­Ø¶ÙŠØ± Ø§Ù„ØµÙˆØ±Ø©...");

        const el = $("receipt");
        const canvas = await html2canvas(el, {
          scale: 2,
          backgroundColor: "#ffffff",
          useCORS: true
        });

        const orderId = ($("orderId").value || "invoice").trim() || "invoice";
        const fileName = `invoice_${orderId}_${Date.now()}.png`;

        canvas.toBlob((blob)=>{
          if(!blob){
            const url = canvas.toDataURL("image/png");
            const a = document.createElement("a");
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            a.remove();
          }else{
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
          }

          if(addToArchiveAfter){
            archiveCurrentInvoice();
          }

          setStatus("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© âœ…");
        }, "image/png");
      }catch(err){
        setStatus("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©: " + (err?.message || err));
      }
    }

    /* =========================
       Draft save (current form)
    ========================= */
    function collectDraft(){
      return {
        orderPrefix: $("orderPrefix").value,
        orderPad: $("orderPad").value,

        shopName: $("shopName").value,
        shopStreet: $("shopStreet").value,
        shopPhone: $("shopPhone").value,
        shopEmail: $("shopEmail").value,
        orderId: $("orderId").value,
        orderDateTime: $("orderDateTime").value,
        orderType: $("orderType").value,
        paymentMethod: $("paymentMethod").value,
        customerName: $("customerName").value,
        customerPhone: $("customerPhone").value,
        customerAddress: $("customerAddress").value,
        currency: $("currency").value,
        appLink: $("appLink").value,
        discount: $("discount").value,
        couponDiscount: $("couponDiscount").value,
        tax: $("tax").value,
        tips: $("tips").value,
        deliveryFee: $("deliveryFee").value,
        footerText: $("footerText").value,
        items: getItems()
      };
    }

    function saveDraftToLocal(){
      localStorage.setItem("receipt_draft_v2", JSON.stringify(collectDraft()));
    }

    function loadDraftFromLocal(){
      const raw = localStorage.getItem("receipt_draft_v2");
      if(!raw) return false;
      try{
        const d = JSON.parse(raw);
        if(!d) return false;
        applyDraft(d);
        return true;
      }catch(e){
        return false;
      }
    }

    function applyDraft(d){
      const set = (id,val)=>{ if($(id)) $(id).value = val ?? ""; };

      set("orderPrefix", d.orderPrefix ?? "ORD-");
      set("orderPad", d.orderPad ?? 6);

      set("shopName", d.shopName);
      set("shopStreet", d.shopStreet);
      set("shopPhone", d.shopPhone);
      set("shopEmail", d.shopEmail);
      set("orderId", d.orderId);
      set("orderDateTime", d.orderDateTime);
      set("orderType", d.orderType);
      set("paymentMethod", d.paymentMethod);
      set("customerName", d.customerName);
      set("customerPhone", d.customerPhone);
      set("customerAddress", d.customerAddress);
      set("currency", d.currency);
      set("appLink", d.appLink);
      set("discount", d.discount);
      set("couponDiscount", d.couponDiscount);
      set("tax", d.tax);
      set("tips", d.tips);
      set("deliveryFee", d.deliveryFee);
      set("footerText", d.footerText);

      const tbody = $("itemsBody");
      tbody.innerHTML = "";
      (d.items || []).forEach(it=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input class="i-name" value="${escapeHtml(it.name)}"></td>
          <td><input class="i-qty" type="number" min="1" value="${it.qty || 1}"></td>
          <td><input class="i-price" type="number" min="0" step="0.01" value="${it.price || 0}"></td>
          <td><button class="btn-danger" type="button" onclick="removeItem(this)">Ø­Ø°Ù</button></td>
        `;
        tbody.appendChild(tr);
      });
      if(!tbody.rows.length){
        addItem();
      }
    }

    /* =========================
       ARCHIVE + CUSTOMERS (LocalStorage)
    ========================= */
    const ARCHIVE_KEY = "invoice_archive_v2";
    const CUSTOMERS_KEY = "customers_phones_v2";

    function getArchive(){
      const raw = localStorage.getItem(ARCHIVE_KEY);
      if(!raw) return [];
      try { return JSON.parse(raw) || []; } catch(e){ return []; }
    }
    function saveArchive(arr){
      localStorage.setItem(ARCHIVE_KEY, JSON.stringify(arr));
    }

    function getCustomers(){
      const raw = localStorage.getItem(CUSTOMERS_KEY);
      if(!raw) return [];
      try { return JSON.parse(raw) || []; } catch(e){ return []; }
    }
    function saveCustomers(arr){
      localStorage.setItem(CUSTOMERS_KEY, JSON.stringify(arr));
    }

    function collectInvoiceForArchive(){
      const draft = collectDraft();
      const totals = calcTotals();
      const createdAt = isoNow();
      const archId = `${(draft.orderId || "ORDER")}-${Date.now()}`;

      return {
        id: archId,
        createdAt,
        ...draft,
        totals
      };
    }

    function upsertCustomerPhone(phone, createdAt){
      phone = String(phone || "").trim();
      if(!phone) return;

      const list = getCustomers();
      const idx = list.findIndex(x => x.phone === phone);
      if(idx === -1){
        list.push({ phone, count: 1, lastAt: createdAt });
      }else{
        list[idx].count = Number(list[idx].count || 0) + 1;
        list[idx].lastAt = createdAt;
      }
      list.sort((a,b)=> (b.count||0) - (a.count||0));
      saveCustomers(list);
    }

    function archiveCurrentInvoice(){
      try{
        renderReceipt();

        // If orderId empty, generate automatically
        if(!($("orderId").value || "").trim()){
          newOrderId();
        }

        const inv = collectInvoiceForArchive();
        const arr = getArchive();

        // prevent duplicates near-in-time
        const recent = arr.find(x =>
          x.orderId === inv.orderId &&
          Math.abs(new Date(x.createdAt).getTime() - new Date(inv.createdAt).getTime()) < 5000
        );
        if(recent){
          setStatus("Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„Ø£Ø±Ø´ÙŠÙ (Ù‚Ø±ÙŠØ¨Ø§Ù‹) âœ…");
          renderArchiveUI();
          return;
        }

        arr.unshift(inv);
        saveArchive(arr);

        upsertCustomerPhone(inv.customerPhone, inv.createdAt);

        setStatus("ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ âœ…");
        renderArchiveUI();
      }catch(err){
        setStatus("ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø£Ø±Ø´ÙŠÙ: " + (err?.message || err));
      }
    }

    function clearArchive(){
      const ok = confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙØŸ");
      if(!ok) return;
      localStorage.removeItem(ARCHIVE_KEY);
      renderArchiveUI();
      setStatus("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø£Ø±Ø´ÙŠÙ");
    }

    function clearCustomers(){
      const ok = confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù„Ø§Ø¦Ø­Ø© Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†ØŸ");
      if(!ok) return;
      localStorage.removeItem(CUSTOMERS_KEY);
      renderArchiveUI();
      setStatus("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø£Ø±Ù‚Ø§Ù…");
    }

    function deleteInvoice(id){
      const ok = confirm("Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙØŸ");
      if(!ok) return;
      const arr = getArchive().filter(x => x.id !== id);
      saveArchive(arr);
      renderArchiveUI();
      setStatus("ØªÙ… Ø§Ù„Ø­Ø°Ù âœ…");
    }

    function openInvoiceFromArchive(id){
      const arr = getArchive();
      const inv = arr.find(x => x.id === id);
      if(!inv){
        setStatus("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø©");
        return;
      }
      applyDraft(inv);
      renderReceipt();
      window.scrollTo({ top: 0, behavior: "smooth" });
      setStatus("ØªÙ… ÙØªØ­ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ âœ…");
    }

    async function downloadImageFromArchive(id){
      const arr = getArchive();
      const inv = arr.find(x => x.id === id);
      if(!inv){
        setStatus("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø©");
        return;
      }
      applyDraft(inv);
      renderReceipt();
      await downloadReceiptImage(false);
      setStatus("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ âœ…");
    }

    function exportArchiveJSON(){
      const arr = getArchive();
      const blob = new Blob([JSON.stringify(arr, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `invoice_archive_${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      setStatus("ØªÙ… ØªØµØ¯ÙŠØ± JSON âœ…");
    }

    function renderArchiveUI(){
      const arr = getArchive();
      const customers = getCustomers();

      $("archiveCount").textContent = `${arr.length} ÙØ§ØªÙˆØ±Ø©`;
      $("customersCount").textContent = `${customers.length} Ø±Ù‚Ù… Ø²Ø¨ÙˆÙ†`;

      const q = ($("archiveSearch").value || "").trim().toLowerCase();
      const filtered = !q ? arr : arr.filter(x => {
        const s = [x.orderId, x.customerName, x.customerPhone, x.customerAddress, x.createdAt].join(" ").toLowerCase();
        return s.includes(q);
      });

      const body = $("archiveBody");
      body.innerHTML = "";

      filtered.slice(0, 300).forEach(inv => {
        const created = inv.createdAt ? new Date(inv.createdAt) : null;
        const dt = created ? created.toLocaleString() : (inv.orderDateTime || "");
        const cur = inv.currency || "";
        const total = inv?.totals?.total ?? 0;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="auto-dir">${escapeHtml(dt)}</td>
          <td class="auto-dir"><strong>${escapeHtml(inv.orderId || "")}</strong></td>
          <td class="auto-dir">${escapeHtml(inv.customerName || "")}</td>
          <td class="auto-dir">${escapeHtml(inv.customerPhone || "")}</td>
          <td class="auto-dir"><strong>${money(total)} ${escapeHtml(cur)}</strong></td>
          <td>
            <div class="rowbtns">
              <button class="btn-ghost btn-xs" type="button" onclick="openInvoiceFromArchive('${inv.id}')">ÙØªØ­</button>
              <button class="btn-blue btn-xs" type="button" onclick="downloadImageFromArchive('${inv.id}')">ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø©</button>
              <button class="btn-danger btn-xs" type="button" onclick="deleteInvoice('${inv.id}')">Ø­Ø°Ù</button>
            </div>
          </td>
        `;
        body.appendChild(tr);
      });

      if(filtered.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="6" class="mini">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</td>`;
        body.appendChild(tr);
      }

      const cbody = $("customersBody");
      cbody.innerHTML = "";
      customers.slice(0, 300).forEach(c=>{
        const dt = c.lastAt ? new Date(c.lastAt).toLocaleString() : "";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="auto-dir"><strong>${escapeHtml(c.phone)}</strong></td>
          <td class="auto-dir">${escapeHtml(String(c.count || 0))}</td>
          <td class="auto-dir">${escapeHtml(dt)}</td>
        `;
        cbody.appendChild(tr);
      });

      if(customers.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="3" class="mini">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø±Ù‚Ø§Ù… Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯.</td>`;
        cbody.appendChild(tr);
      }
    }

    /* =========================
       Auto render on input
    ========================= */
    function wireAutoRender(){
      document.querySelectorAll("input, textarea, select").forEach(el=>{
        el.addEventListener("input", renderReceipt);
        el.addEventListener("change", renderReceipt);
      });

      $("itemsBody").addEventListener("input", (e)=>{
        if(e.target.classList.contains("i-name") ||
           e.target.classList.contains("i-qty") ||
           e.target.classList.contains("i-price")){
          renderReceipt();
        }
      });

      $("archiveSearch").addEventListener("input", renderArchiveUI);
    }

    /* =========================
       Init
    ========================= */
    (function init(){
      // default datetime
      const now = new Date();
      const pad = n => String(n).padStart(2,"0");
      const local = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
      if(!$("orderDateTime").value) $("orderDateTime").value = local;

      loadDraftFromLocal();
      wireAutoRender();
      renderReceipt();
      renderArchiveUI();

      // If no Order ID yet -> generate automatically once
      if(!($("orderId").value || "").trim()){
        newOrderId();
      } else {
        setStatus("Ø¬Ø§Ù‡Ø²");
      }
    })();
  </script>
</body>
</html>
