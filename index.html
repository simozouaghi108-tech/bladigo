<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Receipt Builder - فاتورة مثل التذكرة</title>

  <!-- QR library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --bg:#f3f4f6;
      --card:#ffffff;
      --line:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
      --btn:#111827;
      --btn2:#2563eb;
      --danger:#dc2626;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Tajawal", sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width:1200px;
      margin:18px auto;
      padding:14px;
      display:grid;
      grid-template-columns: 1fr 420px;
      gap:14px;
    }
    @media (max-width: 980px){
      .wrap{grid-template-columns:1fr; }
    }

    .panel{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
    }
    h2{margin:0 0 10px;font-size:16px}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 600px){
      .grid{grid-template-columns:1fr}
    }
    label{font-size:12px;color:var(--muted);display:block;margin:6px 0}
    input, textarea, select{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    textarea{min-height:74px;resize:vertical}
    input:focus, textarea:focus, select:focus{
      border-color:#c7d2fe;
      box-shadow:0 0 0 4px rgba(37,99,235,.12);
    }

    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    button{
      border:none;
      cursor:pointer;
      padding:10px 14px;
      border-radius:12px;
      font-weight:800;
      font-size:14px;
    }
    .btn-dark{background:var(--btn);color:#fff}
    .btn-blue{background:var(--btn2);color:#fff}
    .btn-ghost{background:#fff;border:1px solid var(--line);color:var(--text);font-weight:700}
    .btn-danger{background:var(--danger);color:#fff}

    /* Items table (form) */
    .items{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:12px;
      margin-top:10px;
      background:#fff;
    }
    .items th, .items td{
      padding:10px;
      border-bottom:1px solid var(--line);
      font-size:13px;
      text-align:right;
      vertical-align:middle;
    }
    .items th{
      background:#f9fafb;
      color:#374151;
      font-weight:800;
      white-space:nowrap;
    }
    .items tr:last-child td{border-bottom:none}
    .items input{
      padding:8px 10px;
      border-radius:10px;
      font-size:13px;
    }

    /* Receipt preview (80mm) */
    .receipt-shell{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
    }
    .receipt{
      width:320px;           /* Preview width on screen */
      max-width:100%;
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px 12px;
      box-shadow:0 10px 25px rgba(0,0,0,.06);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
      color:#000;
      direction:ltr;         /* receipts غالباً LTR */
    }
    .center{text-align:center}
    .muted{color:#111}
    .sep{border-top:1px solid #000;margin:10px 0}
    .row2{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:13px;
      line-height:1.45;
    }
    .small{font-size:12px;line-height:1.5}
    .bold{font-weight:800}
    .right{text-align:right}
    .left{text-align:left}
    .auto-dir{direction:auto; unicode-bidi: plaintext;}
    .items-r{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .items-r th, .items-r td{
      padding:6px 0;
      border-bottom:1px solid #000;
    }
    .items-r thead th{
      border-bottom:1px solid #000;
      padding-bottom:8px;
    }
    .items-r tbody tr:last-child td{border-bottom:none}
    .qrbox{
      display:flex;
      justify-content:center;
      margin-top:10px;
    }
    #qrPreview{
      width:128px;height:128px;
    }

    /* Print: only receipt and use 80mm paper */
    @media print{
      body{background:#fff}
      .wrap{display:block; padding:0; margin:0}
      .panel{display:none !important}
      .receipt-shell{display:block}
      .receipt{
        width:80mm;          /* thermal width */
        border:none;
        border-radius:0;
        box-shadow:none;
        padding:6mm 5mm;
      }
      @page{
        size: 80mm auto;
        margin: 0;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- FORM PANEL -->
    <div class="panel">
      <h2>إدخال البيانات (وسيتم توليد فاتورة مثل التذكرة)</h2>

      <div class="grid">
        <div>
          <label>اسم المحل</label>
          <input id="shopName" value="Biryani Box">
        </div>
        <div>
          <label>عنوان المحل (سطر صغير)</label>
          <input id="shopStreet" value="2 mars">
        </div>

        <div>
          <label>هاتف المحل</label>
          <input id="shopPhone" value="+212611113425">
        </div>
        <div>
          <label>بريد المحل</label>
          <input id="shopEmail" value="biryani@gmail.com">
        </div>

        <div>
          <label>Order ID / رقم الطلب</label>
          <input id="orderId" value="100243">
        </div>
        <div>
          <label>التاريخ والوقت</label>
          <input id="orderDateTime" type="datetime-local">
        </div>

        <div>
          <label>نوع الطلب</label>
          <select id="orderType">
            <option value="Delivery">Delivery</option>
            <option value="Pickup">Pickup</option>
          </select>
        </div>
        <div>
          <label>طريقة الدفع</label>
          <select id="paymentMethod">
            <option value="Cash On Delivery">Cash On Delivery</option>
            <option value="Card">Card</option>
            <option value="Online">Online</option>
          </select>
        </div>

        <div>
          <label>اسم الزبون</label>
          <input id="customerName" value="Ivan">
        </div>
        <div>
          <label>هاتف الزبون</label>
          <input id="customerPhone" value="+2120604535185">
        </div>

        <div style="grid-column:1 / -1;">
          <label>عنوان الزبون</label>
          <textarea id="customerAddress">H9GM+8VP, Av. 2 Mars, Casablanca 20250, Morocco</textarea>
        </div>

        <div>
          <label>العملة</label>
          <input id="currency" value="د.م">
        </div>
        <div>
          <label>رابط التطبيق داخل QR (اختياري)</label>
          <input id="appLink" value="https://example.com/app">
        </div>

        <div>
          <label>Discount</label>
          <input id="discount" type="number" step="0.01" value="0">
        </div>
        <div>
          <label>Coupon Discount</label>
          <input id="couponDiscount" type="number" step="0.01" value="0">
        </div>

        <div>
          <label>VAT/Tax (Tax Included)</label>
          <input id="tax" type="number" step="0.01" value="0">
        </div>
        <div>
          <label>Delivery man tips</label>
          <input id="tips" type="number" step="0.01" value="0">
        </div>

        <div>
          <label>Delivery Fee</label>
          <input id="deliveryFee" type="number" step="0.01" value="0">
        </div>
        <div>
          <label>نص أسفل الفاتورة</label>
          <input id="footerText" value="bladigo. Bladigo 2025">
        </div>
      </div>

      <h2 style="margin-top:14px;">المنتجات</h2>
      <table class="items" dir="rtl">
        <thead>
          <tr>
            <th style="width:44%">اسم المنتج</th>
            <th style="width:16%">الكمية</th>
            <th style="width:20%">الثمن</th>
            <th style="width:20%">حذف</th>
          </tr>
        </thead>
        <tbody id="itemsBody">
          <tr>
            <td><input class="i-name" value="كبسة دجاج تقليدية"></td>
            <td><input class="i-qty" type="number" min="1" value="1"></td>
            <td><input class="i-price" type="number" min="0" step="0.01" value="35"></td>
            <td><button class="btn-danger" type="button" onclick="removeItem(this)">حذف</button></td>
          </tr>
        </tbody>
      </table>

      <div class="btns">
        <button class="btn-blue" type="button" onclick="addItem()">+ إضافة منتج</button>
        <button class="btn-ghost" type="button" onclick="renderReceipt()">تحديث الفاتورة</button>
        <button class="btn-dark" type="button" onclick="window.print()">🖨️ طباعة</button>
        <button class="btn-ghost" type="button" onclick="fillSample()">تجربة مثال</button>
      </div>

      <div style="margin-top:10px;color:var(--muted);font-size:12px;line-height:1.6">
        • للطباعة مثل الصورة: من نافذة الطباعة اختر Paper = 80mm (Receipt).<br>
        • إذا أردت نفس الشكل تماماً (خطوط/مسافات)، أخبرني باسم التطبيق وشعارك وسأضبطه لك.
      </div>
    </div>

    <!-- RECEIPT PREVIEW -->
    <div class="receipt-shell">
      <div class="receipt" id="receipt">
        <!-- Header -->
        <div class="center bold" style="font-size:18px" id="rShopName">Biryani Box</div>
        <div class="center small auto-dir" id="rShopStreet">2 mars</div>
        <div class="center small auto-dir" id="rShopPhone">+212611113425</div>
        <div class="center small auto-dir" id="rShopEmail">biryani@gmail.com</div>

        <div class="sep"></div>

        <div class="row2">
          <div class="bold">Order ID:</div>
          <div class="bold auto-dir" id="rOrderId">100243</div>
        </div>
        <div class="small auto-dir" id="rDateTime">31 Jan 2026 17:04</div>

        <div class="sep"></div>

        <div class="row2">
          <div class="bold auto-dir" id="rOrderType">Delivery</div>
          <div class="bold auto-dir" id="rPayment">Cash On Delivery</div>
        </div>

        <div class="sep"></div>

        <!-- Customer -->
        <div class="bold auto-dir" id="rCustomerName">Ivan</div>
        <div class="small auto-dir" id="rCustomerAddress">H9GM+8VP, Av. 2 Mars, Casablanca 20250, Morocco</div>
        <div class="small auto-dir" id="rCustomerPhone">+2120604535185</div>

        <div class="sep"></div>

        <!-- Items -->
        <table class="items-r">
          <thead>
            <tr>
              <th class="left">SL</th>
              <th class="left">Item Info</th>
              <th class="right">Qty</th>
              <th class="right">Price</th>
            </tr>
          </thead>
          <tbody id="rItems"></tbody>
        </table>

        <div class="sep"></div>

        <!-- Totals -->
        <div class="row2"><div>Item Price</div><div><span id="rItemPrice">0.00</span> <span id="rCur1">د.م</span></div></div>
        <div class="row2"><div>Subtotal</div><div><span id="rSubtotal">0.00</span> <span id="rCur2">د.م</span></div></div>
        <div class="row2"><div>Discount</div><div><span id="rDiscount">0.00</span> <span id="rCur3">د.م</span></div></div>
        <div class="row2"><div>Coupon Discount</div><div><span id="rCoupon">0.00</span> <span id="rCur4">د.م</span></div></div>
        <div class="row2"><div>Vat/Tax(Tax Included)</div><div><span id="rTax">0.00</span> <span id="rCur5">د.م</span></div></div>
        <div class="row2"><div>Delivery man tips</div><div><span id="rTips">0.00</span> <span id="rCur6">د.م</span></div></div>
        <div class="row2"><div>Delivery Fee</div><div><span id="rDeliveryFee">0.00</span> <span id="rCur7">د.م</span></div></div>

        <div class="sep"></div>

        <div class="row2" style="font-size:16px;">
          <div class="bold">Total Amount</div>
          <div class="bold"><span id="rTotal">0.00</span> <span id="rCur8">د.م</span></div>
        </div>

        <div class="sep"></div>

        <div class="center bold">Thank You</div>

        <!-- QR -->
        <div class="qrbox">
          <div id="qrPreview"></div>
        </div>

        <div class="sep"></div>
        <div class="center small auto-dir" id="rFooter">bladigo. Bladigo 2025</div>
      </div>
    </div>

  </div>

  <script>
    // Helpers
    const $ = (id)=>document.getElementById(id);
    const money = (n)=>Number(n||0).toFixed(2);

    // QR
    let qrObj = null;
    function buildQR(text){
      const box = $("qrPreview");
      box.innerHTML = "";
      if(!text) return;
      qrObj = new QRCode(box, {
        text,
        width: 120,
        height: 120,
        correctLevel: QRCode.CorrectLevel.M
      });
    }

    // Items
    function addItem(){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input class="i-name" value="منتج جديد"></td>
        <td><input class="i-qty" type="number" min="1" value="1"></td>
        <td><input class="i-price" type="number" min="0" step="0.01" value="0"></td>
        <td><button class="btn-danger" type="button" onclick="removeItem(this)">حذف</button></td>
      `;
      $("itemsBody").appendChild(tr);
      renderReceipt();
    }
    function removeItem(btn){
      const tbody = $("itemsBody");
      const row = btn.closest("tr");
      if(tbody.rows.length === 1){
        row.querySelector(".i-name").value = "منتج 1";
        row.querySelector(".i-qty").value = 1;
        row.querySelector(".i-price").value = 0;
      }else{
        row.remove();
      }
      renderReceipt();
    }

    function getItems(){
      const rows = [...document.querySelectorAll("#itemsBody tr")];
      return rows.map(r=>({
        name: r.querySelector(".i-name").value.trim(),
        qty: Number(r.querySelector(".i-qty").value || 0),
        price: Number(r.querySelector(".i-price").value || 0),
      })).filter(x=>x.name && x.qty>0);
    }

    function formatDateTime(dtLocal){
      // dtLocal like "2026-01-31T17:04"
      if(!dtLocal) return "";
      const d = new Date(dtLocal);
      if(isNaN(d.getTime())) return dtLocal;
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const dd = String(d.getDate()).padStart(2,"0");
      const mon = months[d.getMonth()];
      const yyyy = d.getFullYear();
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `${dd} ${mon} ${yyyy} ${hh}:${mm}`;
    }

    function renderReceipt(){
      // Header
      $("rShopName").textContent = $("shopName").value || "";
      $("rShopStreet").textContent = $("shopStreet").value || "";
      $("rShopPhone").textContent = $("shopPhone").value || "";
      $("rShopEmail").textContent = $("shopEmail").value || "";

      // Order meta
      $("rOrderId").textContent = $("orderId").value || "";
      $("rDateTime").textContent = formatDateTime($("orderDateTime").value) || "";
      $("rOrderType").textContent = $("orderType").value || "";
      $("rPayment").textContent = $("paymentMethod").value || "";

      // Customer
      $("rCustomerName").textContent = $("customerName").value || "";
      $("rCustomerAddress").textContent = $("customerAddress").value || "";
      $("rCustomerPhone").textContent = $("customerPhone").value || "";

      // Currency
      const cur = $("currency").value || "";
      ["rCur1","rCur2","rCur3","rCur4","rCur5","rCur6","rCur7","rCur8"].forEach(id=>{
        $(id).textContent = cur;
      });

      // Items table render
      const items = getItems();
      const tbody = $("rItems");
      tbody.innerHTML = "";
      let itemPriceSum = 0;

      items.forEach((it, idx)=>{
        const line = it.qty * it.price;
        itemPriceSum += line;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="left">${idx+1}</td>
          <td class="left auto-dir">${escapeHtml(it.name)}</td>
          <td class="right">${it.qty}</td>
          <td class="right">${money(line)}</td>
        `;
        tbody.appendChild(tr);
      });

      // Totals
      const discount = Number($("discount").value || 0);
      const coupon = Number($("couponDiscount").value || 0);
      const tax = Number($("tax").value || 0);
      const tips = Number($("tips").value || 0);
      const deliveryFee = Number($("deliveryFee").value || 0);

      const subtotal = itemPriceSum;
      const total = Math.max(subtotal - discount - coupon, 0) + tax + tips + deliveryFee;

      $("rItemPrice").textContent = money(itemPriceSum);
      $("rSubtotal").textContent = money(subtotal);
      $("rDiscount").textContent = money(discount);
      $("rCoupon").textContent = money(coupon);
      $("rTax").textContent = money(tax);
      $("rTips").textContent = money(tips);
      $("rDeliveryFee").textContent = money(deliveryFee);
      $("rTotal").textContent = money(total);

      // Footer + QR
      $("rFooter").textContent = $("footerText").value || "";
      buildQR(($("appLink").value || "").trim());

      // Save (optional)
      saveToLocal();
    }

    // Basic HTML escape for item names
    function escapeHtml(str){
      return String(str||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // LocalStorage (so you don't lose data)
    function saveToLocal(){
      const data = collectData();
      localStorage.setItem("receipt_builder_v1", JSON.stringify(data));
    }
    function loadFromLocal(){
      const raw = localStorage.getItem("receipt_builder_v1");
      if(!raw) return false;
      try{
        const d = JSON.parse(raw);
        if(!d) return false;

        const set = (id,val)=>{ if($(id)) $(id).value = val ?? ""; };

        set("shopName", d.shopName);
        set("shopStreet", d.shopStreet);
        set("shopPhone", d.shopPhone);
        set("shopEmail", d.shopEmail);
        set("orderId", d.orderId);
        set("orderDateTime", d.orderDateTime);
        set("orderType", d.orderType);
        set("paymentMethod", d.paymentMethod);
        set("customerName", d.customerName);
        set("customerPhone", d.customerPhone);
        set("customerAddress", d.customerAddress);
        set("currency", d.currency);
        set("appLink", d.appLink);
        set("discount", d.discount);
        set("couponDiscount", d.couponDiscount);
        set("tax", d.tax);
        set("tips", d.tips);
        set("deliveryFee", d.deliveryFee);
        set("footerText", d.footerText);

        // items
        const tbody = $("itemsBody");
        tbody.innerHTML = "";
        (d.items || []).forEach(it=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><input class="i-name" value="${escapeHtml(it.name)}"></td>
            <td><input class="i-qty" type="number" min="1" value="${it.qty || 1}"></td>
            <td><input class="i-price" type="number" min="0" step="0.01" value="${it.price || 0}"></td>
            <td><button class="btn-danger" type="button" onclick="removeItem(this)">حذف</button></td>
          `;
          tbody.appendChild(tr);
        });

        if(!tbody.rows.length){
          addItem();
        }
        return true;
      }catch(e){
        return false;
      }
    }

    function collectData(){
      return {
        shopName: $("shopName").value,
        shopStreet: $("shopStreet").value,
        shopPhone: $("shopPhone").value,
        shopEmail: $("shopEmail").value,
        orderId: $("orderId").value,
        orderDateTime: $("orderDateTime").value,
        orderType: $("orderType").value,
        paymentMethod: $("paymentMethod").value,
        customerName: $("customerName").value,
        customerPhone: $("customerPhone").value,
        customerAddress: $("customerAddress").value,
        currency: $("currency").value,
        appLink: $("appLink").value,
        discount: $("discount").value,
        couponDiscount: $("couponDiscount").value,
        tax: $("tax").value,
        tips: $("tips").value,
        deliveryFee: $("deliveryFee").value,
        footerText: $("footerText").value,
        items: getItems()
      };
    }

    function fillSample(){
      $("shopName").value = "Biryani Box";
      $("shopStreet").value = "2 mars";
      $("shopPhone").value = "+212611113425";
      $("shopEmail").value = "biryani@gmail.com";
      $("orderId").value = "100243";

      // set current datetime
      const d = new Date();
      const pad = n => String(n).padStart(2,"0");
      const local = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
      $("orderDateTime").value = local;

      $("orderType").value = "Delivery";
      $("paymentMethod").value = "Cash On Delivery";
      $("customerName").value = "Ivan";
      $("customerAddress").value = "H9GM+8VP, Av. 2 Mars, Casablanca 20250, Morocco";
      $("customerPhone").value = "+2120604535185";
      $("currency").value = "د.م";
      $("appLink").value = "https://example.com/app";
      $("discount").value = "0";
      $("couponDiscount").value = "0";
      $("tax").value = "0";
      $("tips").value = "0";
      $("deliveryFee").value = "0";
      $("footerText").value = "bladigo. Bladigo 2025";

      $("itemsBody").innerHTML = `
        <tr>
          <td><input class="i-name" value="كبسة دجاج تقليدية"></td>
          <td><input class="i-qty" type="number" min="1" value="1"></td>
          <td><input class="i-price" type="number" min="0" step="0.01" value="35"></td>
          <td><button class="btn-danger" type="button" onclick="removeItem(this)">حذف</button></td>
        </tr>
      `;
      renderReceipt();
    }

    // Auto render on input changes
    function wireAutoRender(){
      document.querySelectorAll("input, textarea, select").forEach(el=>{
        el.addEventListener("input", renderReceipt);
        el.addEventListener("change", renderReceipt);
      });

      // items live changes
      $("itemsBody").addEventListener("input", (e)=>{
        if(e.target.classList.contains("i-name") ||
           e.target.classList.contains("i-qty") ||
           e.target.classList.contains("i-price")){
          renderReceipt();
        }
      });
    }

    // Init
    (function init(){
      // default datetime if empty
      const now = new Date();
      const pad = n => String(n).padStart(2,"0");
      const local = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
      if(!$("orderDateTime").value) $("orderDateTime").value = local;

      const loaded = loadFromLocal();
      wireAutoRender();
      renderReceipt();
      if(!loaded) renderReceipt();
    })();
  </script>
</body>
</html>
